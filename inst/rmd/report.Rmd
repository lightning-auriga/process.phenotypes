---
title: "Report Template for Audited Phenotype Files"
output:
  html_document:
    code_folding: hide
    md_extensions: "-fancy_lists -emoji"
  highlight: tango
  number_sections: no
  theme: default
  toc: yes
  toc_depth: 3
  toc_float:
    collapsed: no
    smooth_scroll: yes
params:
  dataset.name: ""
  variable.summary: NULL
  phenotype.data: ""
  unique.variable.value.inclusion.proportion: 0.333
---

#### Link input parameters to local variables

```{r link.variables, eval=TRUE, echo=FALSE}
dataset.name <- params$dataset.name
variable.summary <- params$variable.summary
phenotype.data <- params$phenotype.data
unique.variable.value.inclusion.proportion <- params$unique.variable.value.inclusion.proportion
```

#### Load required R packages

```{r load.packages, eval=TRUE, echo=FALSE}
library(ggplot2, quietly = TRUE)
library(knitr, quietly = TRUE)
library(kableExtra, quietly = TRUE)
```

***
<br>

#### Configure default themes for plotting/tables

```{r configure.ggplot2.theme, eval=TRUE, echo=FALSE}
my.theme <- theme_light() + theme(
  plot.title = element_text(size = 16, hjust = 0.5),
  axis.title = element_text(size = 14),
  axis.text = element_text(size = 12),
  strip.background = element_blank(),
  strip.text = element_text(size = 14, colour = "black"),
  legend.title = element_text(size = 14),
  legend.text = element_text(size = 13)
)

knitr.table.attr <- "style=\"width: 90%\""
knitr.contingency.table.attr <- "style=\"width: 50%\""
```

At some point, there should be introductory content here.
`r variable.summary$subjects.excluded.for.age` subjects were
removed for being below the minimum permissible age of
`r variable.summary$globals$min_age_for_inclusion`.


***
<br>

### Report linking between input and standardized variable names

```{r report.variable.mappings, eval=TRUE, echo=FALSE, results="asis"}
variable.mapping.df <- data.frame(
  names(variable.summary$variables),
  sapply(variable.summary$variables, function(i) {
    i$original.name
  })
)
rownames(variable.mapping.df) <- NULL
colnames(variable.mapping.df) <- c("Standardized", "Original")
knitr::kable(variable.mapping.df, caption = "Phenotype Variable Names", table.attr = knitr.table.attr)
```

***
<br>

### Report variable distribution summaries

In this section, each variable in turn is summarized according
to the variable's configured type.

***
<br>

```{r report.value.summary, eval=TRUE, echo=FALSE, results="asis"}
for (name in names(variable.summary$variables)) {
  my.summ <- variable.summary$variables[[name]]$summary
  variable.pretty.name <- variable.summary$variables[[name]]$original.name
  if (!is.null(variable.summary$variables[[name]]$params$identity)) {
    variable.pretty.name <- paste(variable.pretty.name, variable.summary$variables[[name]]$params$identity, sep = "/")
  }

  cat(
    "\n\n### ", variable.pretty.name,
    "\n\nOfficial variable identity: \"",
    variable.summary$variables[[name]]$params$canonical_name, "\"", "\n\n"
  )

  ## report any indication of residual Excel junk in the variable
  if (!is.null(variable.summary$variables[[name]]$excel.problem.count)) {
    if (variable.summary$variables[[name]]$excel.problem.count == 1) {
      cat("\nWARNING: 1 Excel error code detected in this variable.\n")
    } else {
      cat("\nWARNING: ", variable.summary$variables[[name]]$excel.problem.count,
        " Excel error codes detected in this variable.\n",
        sep = ""
      )
    }
  }
  ## if the source data type is numeric
  if (is.vector(phenotype.data[, name], mode = "numeric")) {
    if (length(which(!is.na(phenotype.data[, name])))) {
      ## create data histogram for numeric data
      plot.data <- data.frame(x = phenotype.data[!is.na(phenotype.data[, name]), name])
      hist.plot <- ggplot(data = plot.data) + my.theme
      binwidth <- diff(quantile(plot.data$x, probs = c(0.5, 0.75), na.rm = TRUE)) / 12.5
      hist.plot <- hist.plot + geom_histogram(
        aes(x = x, y = ..count.. / sum(..count..)),
        binwidth = binwidth
      )
      hist.plot <- hist.plot + xlab(name) + ylab("proportion of data")
      cat(
        "\n#### Histogram of ", name, " (", variable.pretty.name,
        ") Distribution\n",
        sep = ""
      )
      print(hist.plot)
    }
  }
  ## if the source data has a linked_date variable, indicating it is an age
  ## that in theory should be derived from a date
  if (!is.null(variable.summary$variables[[name]]$params$linked_date)) {
    reported.year.varname <- variable.summary$variables[[name]]$params$linked_date$reported_year
    reference.year <- variable.summary$variables[[name]]$params$linked_date$reference_year
    stopifnot(
      reported.year.varname %in% names(variable.summary$variables),
      is.numeric(reference.year) |
        (is.character(reference.year) & reference.year %in% names(variable.summary$variables))
    )
    reported.year <- phenotype.data[, reported.year.varname]
    if (is.character(reference.year)) {
      reference.year <- phenotype.data[, reference.year]
    }
    reported.age <- phenotype.data[, name]
    derived.age <- reference.year - reported.year
    plot.data <- data.frame(
      x = reported.age,
      y = derived.age
    )
    plot.data <- plot.data[!is.na(plot.data$x) & !is.na(plot.data$y), ]
    age.plot <- ggplot(aes(x = x, y = y), data = plot.data) + my.theme
    age.plot <- age.plot + geom_point() + geom_abline(slope = 1, intercept = 0)
    age.plot <- age.plot + xlab("Reported Age") + ylab("Age Computed from Date")
    cat("\n\n#### Comparison between reported age ", name, " and age derived from date ",
      reported.year.varname, "\n\n",
      sep = ""
    )
    print(age.plot)
  }
  ## if the source data has a computed_bmi variable, indicating it is BMI
  ## that in theory should be derived from height and weight
  if (!is.null(variable.summary$variables[[name]]$params$computed_bmi)) {
    height.varname <- variable.summary$variables[[name]]$params$computed_bmi$height
    weight.varname <- variable.summary$variables[[name]]$params$computed_bmi$weight
    stopifnot(
      height.varname %in% colnames(phenotype.data),
      weight.varname %in% colnames(phenotype.data)
    )
    reported.bmi <- phenotype.data[, name]
    height.var <- phenotype.data[, height.varname]
    weight.var <- phenotype.data[, weight.varname]
    computed.bmi <- weight.var / height.var^2
    plot.data <- data.frame(
      x = reported.bmi,
      y = computed.bmi
    )
    plot.data <- plot.data[!is.na(plot.data$x) & !is.na(plot.data$y), ]
    bmi.plot <- ggplot(aes(x = x, y = y), data = plot.data) + my.theme
    bmi.plot <- bmi.plot + geom_point() + geom_abline(slope = 1, intercept = 0)
    bmi.plot <- bmi.plot + xlab("Reported BMI") + ylab("BMI Computed from Height/Weight")
    cat("\n\n#### Comparison between reported BMI ", name,
      " and BMI derived from height ", height.varname,
      " and weight ", weight.varname, "\n\n",
      sep = ""
    )
    print(bmi.plot)
  }
  ## if the source data has a computed_bp_ratio variable, plot the ratio
  ## between the systolic and diastolic measurements as indicated
  if (!is.null(variable.summary$variables[[name]]$params$computed_bp_ratio)) {
    systolic.bp <- phenotype.data[, name]
    diastolic.bp.varname <- variable.summary$variables[[name]]$params$computed_bp_ratio$diastolic
    stopifnot(diastolic.bp.varname %in% colnames(phenotype.data))
    diastolic.bp <- phenotype.data[, diastolic.bp.varname]
    plot.data <- data.frame(x = systolic.bp, y = diastolic.bp)
    bp.plot <- ggplot(aes(x = x, y = y), data = plot.data) + my.theme
    bp.plot <- bp.plot + geom_point() + geom_abline(slope = 1, intercept = 0)
    bp.plot <- bp.plot + xlab("Reported systolic BP") + ylab("Reported diastolic BP")
    cat("\n\n#### Comparison between reported systolic ", name,
      " and diastolic blood pressure ", diastolic.bp.varname, "\n\n",
      sep = ""
    )
    print(bp.plot)
  }
  ## original exclusion criterion here is hitting everything for small datasets,
  ## even when the report is not a unique value report
  if (is.vector(phenotype.data[, name], mode = "numeric") |
    is.factor(phenotype.data[, name]) |
    length(my.summ) < nrow(phenotype.data) / 3) {
    variable.summary.df <- data.frame(
      names(my.summ), as.vector(my.summ)
    )
    variable.summary.df[, 1] <- stringr::str_replace(variable.summary.df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
    variable.summary.df[, 1] <- stringr::str_replace(variable.summary.df[, 1], "^( *)([0-9]+)\\. ", "\\1\\2\\\\. ")
    rownames(variable.summary.df) <- NULL
    colnames(variable.summary.df) <- c("Value", "Summary statistics")
    table.caption <- paste("Summary of ", name, " (", variable.pretty.name, ")", sep = "")
    print(knitr::kable(variable.summary.df, caption = table.caption, table.attr = knitr.table.attr))
  } else if (length(my.summ) >= nrow(phenotype.data) * unique.variable.value.inclusion.proportion) {
    cat("\n\nVariable ", name, " (", variable.pretty.name, ") has ", length(my.summ), " unique values, and thus",
      " report output of individual value counts is suppressed.\n\n",
      sep = ""
    )
  }
  if (!is.null(variable.summary$variables[[name]]$invalid.blood.pressure.entries)) {
    if (length(variable.summary$variables[[name]]$invalid.blood.pressure.entries) > 0) {
      df <- data.frame(table(variable.summary$variables[[name]]$invalid.blood.pressure.entries, useNA = "ifany"))
      rownames(df) <- NULL
      colnames(df) <- c(name, "Count")
      df[, 1] <- stringr::str_replace(df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
      print(knitr::kable(df, caption = "Values that were not consistent with blood pressure measurement format.", table.attr = knitr.table.attr))
    } else {
      cat("\n\nAll values consistent with blood pressure format or missing data.\n\n")
    }
  }
  if (!is.null(variable.summary$variables[[name]]$invalid.numeric.entries)) {
    if (length(variable.summary$variables[[name]]$invalid.numeric.entries) > 0) {
      df <- data.frame(table(variable.summary$variables[[name]]$invalid.numeric.entries, useNA = "ifany"))
      rownames(df) <- NULL
      colnames(df) <- c(name, "Count")
      df[, 1] <- stringr::str_replace(df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
      print(knitr::kable(df, caption = "Values that were not consistent with numeric format.", table.attr = knitr.table.attr))
    } else {
      cat("\n\nAll values consistent with numeric format or missing data.\n\n")
    }
  }
  if (!is.null(variable.summary$variables[[name]]$invalid.factor.entries)) {
    if (length(variable.summary$variables[[name]]$invalid.factor.entries) > 0) {
      df <- data.frame(table(variable.summary$variables[[name]]$invalid.factor.entries, useNA = "ifany"))
      rownames(df) <- NULL
      colnames(df) <- c(name, "Count")
      df[, 1] <- stringr::str_replace(df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
      print(knitr::kable(df, caption = "Values that were not consistent with categorical format.", table.attr = knitr.table.attr))
    } else {
      cat("\n\nAll values consistent with categorical format or missing data.\n\n")
    }
  }
  if (!is.null(variable.summary$variables[[name]]$invalid.date.entries)) {
    if (length(variable.summary$variables[[name]]$invalid.date.entries) > 0) {
      df <- data.frame(table(variable.summary$variables[[name]]$invalid.date.entries, useNA = "ifany"))
      rownames(df) <- NULL
      colnames(df) <- c(name, "Count")
      df[, 1] <- stringr::str_replace(df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
      print(knitr::kable(df, caption = "Values that were not consistent with date (year only) format.", table.attr = knitr.table.attr))
    } else {
      cat("\n\nAll values consistent with date format (year only) or missing data.\n\n")
    }
  }
  if (!is.null(variable.summary$variables[[name]]$unicode.entries)) {
    unicode.df <- data.frame(
      names(variable.summary$variables[[name]]$unicode.entries),
      as.vector(variable.summary$variables[[name]]$unicode.entries)
    )
    rownames(unicode.df) <- NULL
    colnames(unicode.df) <- c("Unicode String", "Observations")
    print(knitr::kable(unicode.df, caption = "String entries containing unresolved Unicode characters.", table.attr = knitr.table.attr))
  }
  if (!is.null(variable.summary$variables[[name]]$params$dependencies)) {
    cat("\n\n#### Dependency tracking\n\n")
    dependency.names <- c()
    dependency.conditions <- c()
    dependency.results <- c()
    dependencies <- variable.summary$variables[[name]]$params$dependencies
    for (dependency.index in names(dependencies)) {
      dependency.names <- c(dependency.names, dependencies[[dependency.index]]$name)
      dependency.conditions <- c(dependency.conditions, dependencies[[dependency.index]]$condition)
      dependency.result <- variable.summary$variables[[name]]$dependency.results[[dependency.index]]
      if (length(dependency.result) == 0) {
        dependency.result <- "all subjects pass"
      } else if (length(dependency.result) > 1) {
        dependency.result <- paste(dependency.result, collapse = ", ")
      }
      dependency.results <- c(dependency.results, dependency.result)


      ## allow table_comparisons for simple contingency tables between this and other variables
      if (!is.null(dependencies[[dependency.index]]$table_comparisons)) {
        for (table.target in dependencies[[dependency.index]]$table_comparisons) {
          stopifnot(table.target %in% colnames(phenotype.data))
          comparison.variable.pretty.name <- variable.summary$variables[[table.target]]$original.name
          if (!is.null(variable.summary$variables[[table.target]]$params$identity)) {
            comparison.variable.pretty.name <- paste(comparison.variable.pretty.name,
              variable.summary$variables[[table.target]]$params$identity,
              sep = "/"
            )
          }
          table.data <- table(
            phenotype.data[, table.target],
            phenotype.data[, name],
            useNA = "ifany"
          )
          print(knitr::kable(table.data,
            caption = paste("Contingency table for ",
              table.target,
              " (",
              comparison.variable.pretty.name,
              ") [rows] versus ",
              name,
              " [columns]",
              sep = ""
            ),
            table.attr = knitr.contingency.table.attr
          ))
        }
      }
    }
    dependency.df <- data.frame(
      Name = dependency.names,
      Condition = dependency.conditions,
      Result = dependency.results
    )
    rownames(dependency.df) <- NULL
    print(knitr::kable(dependency.df, caption = "Results of cross-variable dependency tests.", table.attr = knitr.table.attr))
  }
  cat("\n***\n<br>\n")
}
```

***
<br>

#### Session Information

<br>

The following summarizes the loaded R configuration for the run that created this report.

```{r session.info, eval=TRUE, echo=TRUE}
sessionInfo()
```
