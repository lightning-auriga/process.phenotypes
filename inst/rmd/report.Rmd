---
title: "Report Template for Audited Phenotype Files"
output:
  html_document:
    code_folding: hide
    md_extensions: "-fancy_lists -emoji"
  highlight: tango
  number_sections: no
  theme: default
  toc: yes
  toc_depth: 3
  toc_float:
    collapsed: no
    smooth_scroll: yes
  params:
    dataset.name: ""
    variable.summary: NULL
    phenotype.data: ""
---

#### Load required R packages

```{r load.packages, eval=TRUE, echo=FALSE}
library(ggplot2, quietly = TRUE)
library(knitr, quietly = TRUE)
library(kableExtra, quietly = TRUE)
```

***
<br>

#### Configure default ggplot2 theme for plotting

```{r configure.ggplot2.theme, eval=TRUE, echo=FALSE}
my.theme <- theme_light() + theme(
  plot.title = element_text(size = 16, hjust = 0.5),
  axis.title = element_text(size = 14),
  axis.text = element_text(size = 12),
  strip.background = element_blank(),
  strip.text = element_text(size = 14, colour = "black"),
  legend.title = element_text(size = 14),
  legend.text = element_text(size = 13)
)
```

At some point, there should be introductory content here.
`r variable.summary$subjects.excluded.for.age` subjects were
removed for being below the minimum permissible age of
`r variable.summary$globals$min_age_for_inclusion`.


***
<br>

### Report linking between input and standardized variable names

```{r report.variable.mappings, eval=TRUE, echo=FALSE, results="asis"}
variable.mapping.df <- data.frame(
  names(variable.summary$variables),
  sapply(variable.summary$variables, function(i) {
    i$original.name
  })
)
rownames(variable.mapping.df) <- NULL
colnames(variable.mapping.df) <- c("Standardized", "Original")
knitr::kable(variable.mapping.df, caption = "Phenotype Variable Names")
```

***
<br>

### Report variable distribution summaries

In this section, each variable in turn is summarized according
to the variable's configured type.

***
<br>

```{r report.value.summary, eval=TRUE, echo=FALSE, results="asis"}
for (name in names(variable.summary$variables)) {
  my.summ <- variable.summary$variables[[name]]$summary
  ## if the source data type is numeric
  if (is.vector(phenotype.data[, name], mode = "numeric")) {
    if (length(which(!is.na(phenotype.data[, name])))) {
      ## create data histogram for numeric data
      plot.data <- data.frame(x = phenotype.data[!is.na(phenotype.data[, name]), name])
      hist.plot <- ggplot(data = plot.data) + my.theme
      binwidth <- diff(quantile(plot.data$x, probs = c(0.5, 0.75), na.rm = TRUE)) / 12.5
      hist.plot <- hist.plot + geom_histogram(
        aes(x = x, y = ..count.. / sum(..count..)),
        binwidth = binwidth
      )
      hist.plot <- hist.plot + xlab(name) + ylab("proportion of data")
      cat(
        "\n#### Histogram of ", name, " (", variable.summary$variables[[name]]$original.name,
        ") Distribution\n",
        sep = ""
      )
      print(hist.plot)
    }
  }
  ## original exclusion criterion here is hitting everything for small datasets,
  ## even when the report is not a unique value report
  if (is.vector(phenotype.data[, name], mode = "numeric") |
    is.factor(phenotype.data[, name]) |
    length(my.summ) < nrow(phenotype.data) / 3) {
    variable.summary.df <- data.frame(
      names(my.summ), as.vector(my.summ)
    )
    variable.summary.df[, 1] <- stringr::str_replace(variable.summary.df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
    variable.summary.df[, 1] <- stringr::str_replace(variable.summary.df[, 1], "^( *)([0-9]+)\\. ", "\\1\\2\\\\. ")
    rownames(variable.summary.df) <- NULL
    colnames(variable.summary.df) <- c("Value", "Summary statistics")
    print(knitr::kable(variable.summary.df, caption = paste("Summary of ", name, " (", variable.summary$variables[[name]]$original.name, ")", sep = "")))
  } else if (length(my.summ) >= nrow(phenotype.data) / 3) {
    cat("\nVariable ", name, " (", variable.summary$variables[[name]]$original.name, ") has ", length(my.summ), " unique values, and thus",
      " report output of individual value counts is suppressed.\n",
      sep = ""
    )
  }
  if (!is.null(variable.summary$variables[[name]]$invalid.blood.pressure.entries)) {
    if (length(variable.summary$variables[[name]]$invalid.blood.pressure.entries) > 0) {
      df <- data.frame(table(variable.summary$variables[[name]]$invalid.blood.pressure.entries, useNA = "ifany"))
      rownames(df) <- NULL
      colnames(df) <- c(name, "Count")
      df[, 1] <- stringr::str_replace(df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
      print(knitr::kable(df, caption = "Values that were not consistent with blood pressure measurement format."))
    } else {
      cat("\nAll values consistent with blood pressure format or missing data.\n")
    }
  }
  if (!is.null(variable.summary$variables[[name]]$invalid.numeric.entries)) {
    if (length(variable.summary$variables[[name]]$invalid.numeric.entries) > 0) {
      df <- data.frame(table(variable.summary$variables[[name]]$invalid.numeric.entries, useNA = "ifany"))
      rownames(df) <- NULL
      colnames(df) <- c(name, "Count")
      df[, 1] <- stringr::str_replace(df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
      print(knitr::kable(df, caption = "Values that were not consistent with numeric format."))
    } else {
      cat("\nAll values consistent with numeric format or missing data.\n")
    }
  }
  if (!is.null(variable.summary$variables[[name]]$invalid.factor.entries)) {
    if (length(variable.summary$variables[[name]]$invalid.factor.entries) > 0) {
      df <- data.frame(table(variable.summary$variables[[name]]$invalid.factor.entries, useNA = "ifany"))
      rownames(df) <- NULL
      colnames(df) <- c(name, "Count")
      df[, 1] <- stringr::str_replace(df[, 1], "^( *)([\\+\\*])", "\\1\\\\\\2")
      print(knitr::kable(df, caption = "Values that were not consistent with categorical format."))
    } else {
      cat("\nAll values consistent with categorical format or missing data.\n")
    }
  }
  if (!is.null(variable.summary$variables[[name]]$excel.problem.count)) {
    if (variable.summary$variables[[name]]$excel.problem.count == 1) {
      cat("\nWARNING: 1 Excel error code detected in this variable.\n")
    } else {
      cat("\nWARNING: ", variable.summary$variables[[name]]$excel.problem.count,
        " Excel error codes detected in this variable.\n",
        sep = ""
      )
    }
  }
  if (!is.null(variable.summary$variables[[name]]$unicode.entries)) {
    unicode.df <- data.frame(
      names(variable.summary$variables[[name]]$unicode.entries),
      as.vector(variable.summary$variables[[name]]$unicode.entries)
    )
    rownames(unicode.df) <- NULL
    colnames(unicode.df) <- c("Unicode String", "Observations")
    print(knitr::kable(unicode.df, caption = "String entries containing unresolved Unicode characters."))
  }
  cat("\n***\n<br>\n")
}
```

***
<br>

#### Session Information

<br>

The following summarizes the loaded R configuration for the run that created this report.

```{r session.info, eval=TRUE, echo=TRUE}
sessionInfo()
```
